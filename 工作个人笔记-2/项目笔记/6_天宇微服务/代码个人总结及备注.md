### 1，GoodsSpuApi.java，修改促销价格

```java
@ApiOperation(value = "分页查询")
    @GetMapping("/page")
    public R getGoodsSpuPage(Page<GoodsSpu> page, GoodsSpu goodsSpu, String couponUserId) {
        String mallUserId = ThirdSessionHolder.getMallUserId();
        UserInfo userInfo = userInfoService.getById(mallUserId);
        goodsSpu.setShelf(CommonConstants.YES);
        CouponUser couponUser = null;
        if (StrUtil.isNotBlank(couponUserId)) {
            couponUser = couponUserService.getById(couponUserId);
            couponUser.setPromotions(Arrays.asList(couponUser.getPromotion()));
            couponUser.setMemberLevels(Arrays.asList(couponUser.getMemberLevel()));
        }
        IPage<GoodsSpu> iPage = goodsSpuService.page2(page, goodsSpu, couponUser);
        //1,把查询的结果进行循环，改变促销价格
        iPage.getRecords().forEach(spu -> {
            BigDecimal tejia = BigDecimal.ZERO;
            List<GoodsSku> goodsSkus = goodsSkuService.listGoodsSkuBySpuId(spu.getId());
            for (GoodsSku sku : goodsSkus) {
                spu.setOriginalPrice(sku.getSalesPrice());
                tejia = sku.getBargainPrice() == null ? BigDecimal.ZERO : sku.getBargainPrice();
                if (tejia.compareTo(BigDecimal.ZERO) > 0) {
                    sku.setSalesPrice(tejia);
                    spu.setPrice(tejia);
                }
            }
            spu.setSkus(goodsSkus);
            //2,从这里开始，查询是否是促销，如果是，则修改价格price
            if (tejia.compareTo(BigDecimal.ZERO) <= 0) {
                //3,这里查询会员级别，确定是否参加促销
                MemberLevel memberLevel = memberLevelService.getOne(Wrappers.<MemberLevel>lambdaQuery().eq(MemberLevel::getLevel, userInfo.getUserGrade()));
                List<String> strings = Arrays.asList(memberLevel.getPromotion());
                //获取促销标签，即promotionId
                List<String> collect = strings.stream().filter(s -> s.equals(spu.getPromotionId())).collect(Collectors.toList());
                //判断根据促销来修改价格
                if (!collect.isEmpty()) {
                    spu.setPrice(memberLevel.getDiscount().divide(new BigDecimal(10), 2, BigDecimal.ROUND_UP).multiply(spu.getPrice()).setScale(2, BigDecimal.ROUND_HALF_UP));
                }
            }
        });
        return R.ok(iPage);
    }
```


### 1，GoodsSpuApi.java，修改促销价格

```java
@ApiOperation(value = "分页查询")
    @GetMapping("/page")
    public R getGoodsSpuPage(Page<GoodsSpu> page, GoodsSpu goodsSpu, String couponUserId) {
        String mallUserId = ThirdSessionHolder.getMallUserId();
        UserInfo userInfo = userInfoService.getById(mallUserId);
        goodsSpu.setShelf(CommonConstants.YES);
        CouponUser couponUser = null;
        if (StrUtil.isNotBlank(couponUserId)) {
            couponUser = couponUserService.getById(couponUserId);
            couponUser.setPromotions(Arrays.asList(couponUser.getPromotion()));
            couponUser.setMemberLevels(Arrays.asList(couponUser.getMemberLevel()));
        }
        IPage<GoodsSpu> iPage = goodsSpuService.page2(page, goodsSpu, couponUser);
        //1,把查询的结果进行循环，改变促销价格
        iPage.getRecords().forEach(spu -> {
            BigDecimal tejia = BigDecimal.ZERO;
            List<GoodsSku> goodsSkus = goodsSkuService.listGoodsSkuBySpuId(spu.getId());
            for (GoodsSku sku : goodsSkus) {
                spu.setOriginalPrice(sku.getSalesPrice());
                tejia = sku.getBargainPrice() == null ? BigDecimal.ZERO : sku.getBargainPrice();
                if (tejia.compareTo(BigDecimal.ZERO) > 0) {
                    sku.setSalesPrice(tejia);
                    spu.setPrice(tejia);
                }
            }
            spu.setSkus(goodsSkus);
            //2,从这里开始，查询是否是促销，如果是，则修改价格price
            if (tejia.compareTo(BigDecimal.ZERO) <= 0) {
                //3,这里查询会员级别，确定是否参加促销
                MemberLevel memberLevel = memberLevelService.getOne(Wrappers.<MemberLevel>lambdaQuery().eq(MemberLevel::getLevel, userInfo.getUserGrade()));
                List<String> strings = Arrays.asList(memberLevel.getPromotion());
                //获取促销标签，即promotionId
                List<String> collect = strings.stream().filter(s -> s.equals(spu.getPromotionId())).collect(Collectors.toList());
                //判断根据促销来修改价格
                if (!collect.isEmpty()) {
                    spu.setPrice(memberLevel.getDiscount().divide(new BigDecimal(10), 2, BigDecimal.ROUND_UP).multiply(spu.getPrice()).setScale(2, BigDecimal.ROUND_HALF_UP));
                }
            }
        });
        return R.ok(iPage);
    }
```

### 2，项目中Feign使用方法

本例是在微信模块使用Feign调用mall模块的接口

(1)编写FeignService接口；

```java
//base-weixin-admin模块
package com.uk.cloud.weixin.common.feign;

@Service
@FeignClient(contextId = "feignMeiTuanService",value = ServiceNameConstants.MALL_ADMIN_SERVICE)
public interface FeignMeiTuanService {

    //校验配送能力
    @PostMapping(value = "/delivery/meituan/checkOrder")
    public abstract R checkOrder(@RequestBody WxUser wxUser, @RequestHeader(SecurityConstants.FROM) String from);
//注意要加@RequestHeader(SecurityConstants.FROM) 注解
}
```

(2)在base-weixin-admin模块内的controller层调用FeignService

```java
public class WxUserApi {
   
	@ApiOperation(value = "小程序用户登录")
	@PostMapping("/login")
	public R login(HttpServletRequest request, @RequestBody LoginMaDTO loginMaDTO){
			//.....
			//测试数据
			wxUser.setStoreId("0074");  //需要传入查询出的最近门店id
			wxUser.setLongitude(114.402493);
			wxUser.setLatitude(37.128112);
			wxUser.setAddress("凯天医药邢台市信都区");
        //注意这里实参是：SecurityConstants.FROM_IN，对应下面的@Inside注解，否则无权限访问下面的接口
            R r = feignMeiTuanService.checkOrder(wxUser, SecurityConstants.FROM_IN);
			if(!r.isOk()){  //不能配送则按县区价格展示，打标记
				wxUser.setInCity("0");
			}
         //.....
		
}
```



**注意要在被调用的Controller接口上加@Inside注解，否则没有访问接口权限 (base-mall-admin模块)**

```java
package com.uk.cloud.mall.admin.controller;

@ApiOperation(value = "校验配送能力")
	@Inside
	@PostMapping("/checkOrder")
	public R checkOrder(@RequestBody WxUser wxUser){
		String storeId = wxUser.getStoreId();
		String location = wxUser.getLongitude() + "," + wxUser.getLatitude();   //用户经纬度拼接，例"114.540352,37.085315"
		String address = wxUser.getAddress();	//用户地址
		JSONObject checkOrderObj = new JSONObject();
		try {
			checkOrderObj = meiTuanOpenService.checkOrder(storeId, location, address);

		} catch (IOException e) {
			e.printStackTrace();
		} catch (NoSuchAlgorithmException e) {
			e.printStackTrace();
		}
		return R.ok(checkOrderObj);

	}
```



### 3，美团接口状态码含义

https://page.peisong.meituan.com/open/doc#section4-1

请求返回状态码定义

0为请求成功

1-99为平台错误

100以上为业务错误

